!function(){"use strict";function e(e){return e.status>=200&&e.status<300||304===e.status}function t(e,t,n){var r=new FormData;return n&&Object.keys(n).forEach(function(e){r.append(e,n[e])}),r.append(e,t),r}document.addEventListener&&document.addEventListener("change",function(n){var r=n.target;if("INPUT"===r.tagName&&"file"===r.type&&r.getAttribute("data-direct")){if(!r.files)return;var a=r.getAttribute("data-reference"),i=document.querySelector("input[type=hidden][data-reference='"+a+"']"),s=r.getAttribute("data-url"),u=JSON.parse(r.getAttribute("data-fields")||"null"),d=[].map.call(r.files,function(n,a){function i(e,t,r){var i=document.createEvent("CustomEvent");i.initCustomEvent(t,!0,!1,{xhr:l,file:n,index:a,progress:r}),e.dispatchEvent(i)}var l=new XMLHttpRequest;if(l.file=n,l.addEventListener("load",function(){l.complete=!0,d.every(function(e){return e.complete})&&o(),e(l)?i(r,"upload:success"):i(r,"upload:failure"),i(r,"upload:complete")}),l.upload.addEventListener("progress",function(e){i(r,"upload:progress",e)}),r.getAttribute("data-presigned")){i(r,"presign:start");var p=new XMLHttpRequest,c=s+"?t="+Date.now()+"."+a;p.addEventListener("load",function(){if(i(r,"presign:complete"),e(p)){i(r,"presign:success");var a=JSON.parse(p.responseText);l.id=a.id,l.open("POST",a.url,!0),l.send(t(a.as,n,a.fields)),i(r,"upload:start")}else i(r,"presign:failure"),l.complete=!0}),p.open("GET",c,!0),p.send()}else l.open("POST",s,!0),l.send(t(r.getAttribute("data-as"),n,u)),i(r,"upload:start");return l});d.length&&r.classList.add("uploading");var o=function(){if(r.classList.remove("uploading"),d.every(e)){var t=d.map(function(e){var t,n={filename:e.file.name,content_type:e.file.type,size:e.file.size};try{t=JSON.parse(e.responseText)}catch(i){t={}}var r=e.id||t.id,a=e.url||t.url;return r&&(n.id=r),a&&(n.url=a),n});r.multiple||(t=t[0]),i&&(i.value=JSON.stringify(t)),r.removeAttribute("name")}}}})}();